<!doctype html>
<html lang="en">
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js" crossorigin="anonymous"></script>
  <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/Chart.js/2.1.2/Chart.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script> 
</head>
<body>

  <canvas id="lineChart"></canvas>

  <script type="text/javascript">
    const MONTHS = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

    function parseDate(val){
      return new Date(val);
    }

    function date2Str(d, forceFull){
      var str = "";

      if(forceFull || d.getMonth() == 0)
        str = str + d.getFullYear() + " ";

      str = str + MONTHS[d.getMonth()] + " " + ("0" + d.getDate()).slice(-2);

      return str;
    }

    function showGraph(canvasId, x, y, dpts){

      var ctxL = document.getElementById(canvasId).getContext('2d');
      var myChart = new Chart(ctxL, {
          type: 'scatter',
          data: {
            datasets: [
                {
                  label: 'Pledges',
                    //borderWidth: 2,
                    data: dpts
                }
            ]
          },
          options: {
            responsive: true,
            legend:{
              display:false
            },
            elements: {
              line: {
                  tension: 0.001
              }
            },
            animation: {
              duration: 1000 // general animation time
            },
            scales: {
              xAxes: [{
                ticks: {
                  //Custom date labels in the ticks
                  callback: function(value, index, values) {
                    return date2Str(new Date(value));
                  }
                }
              }],
              yAxes: [{
                ticks: {
                  // Include a dollar sign and commas in the ticks
                  callback: function(value, index, values) {
                    return '$' + value.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
                  } 
                }
              }]
            },
            tooltips: {
              enabled: true,
              mode: 'single',
              bodyFontSize: 12,
              backgroundColor: '#6A0000',
              callbacks: {
                //Custom tooltip labels
                label: function(tooltipItems, data) {
                  var d = new Date(tooltipItems.xLabel);

                  var labelVals = [date2Str(d, true)];

                  if(tooltipItems.index > 0){
                    var prev = data.datasets[tooltipItems.datasetIndex].data[tooltipItems.index - 1].y;
                    var inc = (tooltipItems.yLabel - prev).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
                    labelVals.push("    Pledge: $" + inc);   
                  }

                  var total = tooltipItems.yLabel.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
                  labelVals.push("    Total: $" + total);   

                  return labelVals;
                }
              }
            }
          }
      });
      myChart.render();
    }

    $(function() {

      var spreadsheetId = "1VfuLJzB6ygO4SKC77yU9iO7UZWOC9zI4PmhJAXbQR8A",
        url = "https://spreadsheets.google.com/feeds/list/" +
              spreadsheetId +
              "/od6/public/basic?alt=json";

      $.get({
        url: url,
        success: function(response) {
          var data = response.feed.entry,
              len = data.length,
              i = 0,
              dates = [],
              values = [],
              dpts = [];

          for (i = 0; i < len; i++) {
            var cont = data[i].content.$t;
            //console.log(cont)
            var n = cont.indexOf("pledge");
            if(n >= 0){
              n = cont.indexOf("totalamount");
              cont = cont.substring(n+13);
              cont = cont.replace('$', '').replace(',', '');
              var amount = Number(cont);
              
              //NOTE: Due to some odd reason, the date-time value read from the
              //spreadsheet cell is always one day behind the actual date set
              //at the spreadsheet. Also, the vertical gridline has some offset than
              //the label. We calculate and add some offset in milliseconds, which was 
              //caluclated emperically to compensate for this lag. 
              
              var timeOffsetCompensation = 43200000; //add 12 hours
              //var timeOffsetCompensation = 0; //21600000; //add 6 hours
              var d = new Date(new Date(data[i].title.$t).getTime() + timeOffsetCompensation);

              //console.log(amount + " on " + d);

              dpts.push({x:d, y:amount});
            }
          } 

          showGraph("lineChart", dates, values, dpts);
        }
      });

    });
  </script>
</body>
</html>